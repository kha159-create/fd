
import React, { useState, useRef, useEffect } from 'react';
import { Message, FinancialCalculations } from '../../types';
import { analyzeFinancialData } from '../../services/geminiService';
import { SendIcon } from '../common/Icons';

interface AIAssistantTabProps {
    calculations: FinancialCalculations,
    filteredTransactions: any,
}

const TypingIndicator: React.FC = () => (
  <div className="ai-bubble chat-bubble typing-indicator flex items-center space-x-1 p-3 self-start">
    <span className="block w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.3s]"></span>
    <span className="block w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.15s]"></span>
    <span className="block w-2 h-2 bg-gray-400 rounded-full animate-pulse"></span>
  </div>
);

const AIAssistantTab: React.FC<AIAssistantTabProps> = ({ calculations, filteredTransactions }) => {
    const [messages, setMessages] = useState<Message[]>([
        { id: '1', text: 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„. ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªØ³Ø£Ù„Ù†ÙŠ Ø£Ø³Ø¦Ù„Ø© ØªÙØµÙŠÙ„ÙŠØ© Ø¹Ù† ÙˆØ¶Ø¹Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠØŒ Ù…Ø«Ù„ "Ù…Ø§ Ù‡Ùˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯ÙŠÙˆÙ†ÙŠØŸ" Ø£Ùˆ "Ù‡Ù„ Ø¥Ù†ÙØ§Ù‚ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø£Ù‡Ø¯Ø§ÙÙŠØŸ"', sender: 'ai' }
    ]);
    const [userInput, setUserInput] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const chatBoxRef = useRef<HTMLDivElement>(null);

    useEffect(() => {
        chatBoxRef.current?.scrollTo(0, chatBoxRef.current.scrollHeight);
    }, [messages, isLoading]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        const query = userInput.trim();
        if (!query || isLoading) return;

        const newUserMessage: Message = { id: Date.now().toString(), text: query, sender: 'user' };
        setMessages(prev => [...prev, newUserMessage]);
        setUserInput('');
        setIsLoading(true);

        try {
            const fullContext = {
                periodSummary: calculations,
                transactions: filteredTransactions
            };
            const aiResponseText = await analyzeFinancialData(query, fullContext);
            const newAiMessage: Message = { id: (Date.now() + 1).toString(), text: aiResponseText, sender: 'ai' };
            setMessages(prev => [...prev, newAiMessage]);
        } catch (error) {
            const errorMessage: Message = { id: (Date.now() + 1).toString(), text: error instanceof Error ? error.message : 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', sender: 'ai' };
            setMessages(prev => [...prev, errorMessage]);
        } finally {
            setIsLoading(false);
        }
    };
    
    return (
        <div className="glass-card overflow-hidden flex flex-col" style={{ height: '70vh' }}>
            <div className="p-4 bg-gray-100 text-center flex-shrink-0"><h3 className="text-xl font-bold text-slate-900">ğŸ¤– Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h3><p className="text-sm text-slate-500">Ø§Ø³Ø£Ù„ Ø£ÙŠ Ø´ÙŠØ¡ Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯</p></div>
            <div ref={chatBoxRef} className="p-4 flex-grow overflow-y-auto flex flex-col gap-4">
                {messages.map(msg => (
                    <div key={msg.id} className={`chat-bubble ${msg.sender === 'user' ? 'user-bubble' : 'ai-bubble'}`}>
                       <p dangerouslySetInnerHTML={{ __html: msg.text.replace(/\n/g, '<br />') }} />
                    </div>
                ))}
                {isLoading && <TypingIndicator />}
            </div>
            <div className="p-4 border-t border-gray-200 flex-shrink-0">
                <form onSubmit={handleSubmit} className="flex gap-2">
                    <input type="text" value={userInput} onChange={e => setUserInput(e.target.value)} className="w-full p-3" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." required autoComplete="off" disabled={isLoading} />
                    <button type="submit" disabled={isLoading} className="p-3 magical-button text-white rounded-lg flex-shrink-0 disabled:opacity-50">
                       <SendIcon />
                    </button>
                </form>
            </div>
        </div>
    );
};

export default AIAssistantTab;